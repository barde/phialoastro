name: Webhook Deployment

on:
  repository_dispatch:
    types: [deploy-preview, deploy-production]

permissions:
  contents: read
  deployments: write

jobs:
  validate-webhook:
    runs-on: ubuntu-latest
    outputs:
      valid: ${{ steps.validate.outputs.valid }}
      environment: ${{ steps.validate.outputs.environment }}
      branch: ${{ steps.validate.outputs.branch }}
    steps:
      - name: Validate webhook payload
        id: validate
        run: |
          # Extract environment from event type
          if [ "${{ github.event.action }}" = "deploy-production" ]; then
            ENVIRONMENT="production"
          else
            ENVIRONMENT="preview"
          fi
          
          # Extract branch from payload (default to master)
          BRANCH="${{ github.event.client_payload.branch }}"
          if [ -z "$BRANCH" ]; then
            BRANCH="master"
          fi
          
          # Validate secret token if provided
          if [ -n "${{ github.event.client_payload.token }}" ]; then
            # In a real scenario, you'd validate this against a stored secret
            echo "Token validation would happen here"
          fi
          
          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "valid=true" >> $GITHUB_OUTPUT
          
          echo "Webhook deployment request:"
          echo "- Environment: $ENVIRONMENT"
          echo "- Branch: $BRANCH"
          echo "- Triggered at: $(date -u)"

  deploy:
    needs: validate-webhook
    if: needs.validate-webhook.outputs.valid == 'true'
    runs-on: ubuntu-latest
    environment: ${{ needs.validate-webhook.outputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ needs.validate-webhook.outputs.branch }}
      
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'phialo-design/pnpm-lock.yaml'
      
      - name: Install dependencies
        working-directory: ./phialo-design
        run: pnpm install --frozen-lockfile
      
      - name: Install worker dependencies
        working-directory: ./workers
        run: pnpm install --frozen-lockfile
      
      - name: Build Astro site
        uses: ./.github/actions/build-astro
        with:
          working-directory: ./phialo-design
          PUBLIC_TURNSTILE_SITE_KEY: ${{ secrets.PUBLIC_TURNSTILE_SITE_KEY }}
          PUBLIC_CLOUDFLARE_ANALYTICS_TOKEN: ${{ secrets.PUBLIC_CLOUDFLARE_ANALYTICS_TOKEN }}
      
      - name: Install Wrangler
        working-directory: ./workers
        run: pnpm install wrangler@4.32.0
      
      - name: Deploy to Cloudflare Workers
        working-directory: ./workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # Deploy the worker
          npx wrangler deploy --env ${{ needs.validate-webhook.outputs.environment }}
          
          # Determine the worker name based on environment
          if [ "${{ needs.validate-webhook.outputs.environment }}" = "production" ]; then
            WORKER_NAME="phialo"
          else
            WORKER_NAME="phialo-design-preview"
          fi
          
          # Set secrets for the deployed worker
          echo "${{ secrets.RESEND_API_KEY }}" | npx wrangler secret put RESEND_API_KEY --name $WORKER_NAME --env=""
          echo "${{ secrets.FROM_EMAIL }}" | npx wrangler secret put FROM_EMAIL --name $WORKER_NAME --env=""
          echo "${{ secrets.TO_EMAIL }}" | npx wrangler secret put TO_EMAIL --name $WORKER_NAME --env=""
          echo "${{ secrets.TURNSTILE_SECRET_KEY }}" | npx wrangler secret put TURNSTILE_SECRET_KEY --name $WORKER_NAME --env=""
          
          # Set optional REPLY_TO_EMAIL if it exists
          if [ -n "${{ secrets.REPLY_TO_EMAIL }}" ]; then
            echo "${{ secrets.REPLY_TO_EMAIL }}" | npx wrangler secret put REPLY_TO_EMAIL --name $WORKER_NAME --env=""
          fi
      
      - name: Send webhook response
        if: github.event.client_payload.callback_url
        run: |
          DEPLOYMENT_URL="https://phialo.de"
          if [ "${{ needs.validate-webhook.outputs.environment }}" = "preview" ]; then
            DEPLOYMENT_URL="https://phialo-design-preview.meise.workers.dev"
          fi
          
          # Send callback to webhook sender
          curl -X POST "${{ github.event.client_payload.callback_url }}" \
            -H "Content-Type: application/json" \
            -d '{
              "status": "success",
              "environment": "${{ needs.validate-webhook.outputs.environment }}",
              "url": "'$DEPLOYMENT_URL'",
              "deployed_at": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'",
              "run_id": "${{ github.run_id }}"
            }'