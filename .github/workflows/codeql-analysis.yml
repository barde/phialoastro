name: "CodeQL Security Analysis"

on:
  # Nightly security scan
  schedule:
    - cron: '0 3 * * *'  # Daily at 3 AM UTC
  
  # Manual trigger for urgent security reviews
  workflow_dispatch:

jobs:
  check-changes:
    name: Check for Changes
    runs-on: ubuntu-latest
    outputs:
      has-changes: ${{ steps.check.outputs.changed }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        fetch-depth: 2  # Need to check last commit
    
    - name: Check if master changed in last 24 hours
      id: check
      run: |
        # Get commits from last 24 hours on master
        LAST_COMMIT_TIME=$(git log -1 --format=%ct origin/master)
        CURRENT_TIME=$(date +%s)
        TIME_DIFF=$((CURRENT_TIME - LAST_COMMIT_TIME))
        
        # 86400 seconds = 24 hours
        if [ $TIME_DIFF -lt 86400 ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "Master branch has changes from last 24 hours"
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "No recent changes to master branch"
        fi

  analyze:
    name: Analyze
    needs: check-changes
    # Only run if there were changes or manually triggered
    if: needs.check-changes.outputs.has-changes == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: javascript-typescript
        queries: security-and-quality
        
    - name: Setup Node.js
      uses: actions/setup-node@v5
      with:
        node-version: '20'

    - name: Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9.14.4

    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.pnpm-store
          phialo-design/node_modules
        key: ${{ runner.os }}-pnpm-codeql-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-codeql-

    - name: Install dependencies
      working-directory: phialo-design
      run: pnpm install --frozen-lockfile --prefer-offline

    - name: Minimal build for analysis
      working-directory: phialo-design
      env:
        NODE_ENV: production
        PUBLIC_TURNSTILE_SITE_KEY: ${{ secrets.PUBLIC_TURNSTILE_SITE_KEY || 'dummy-key' }}
      run: |
        # Only typecheck for CodeQL analysis
        pnpm run typecheck || true

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:javascript-typescript"

    - name: Create summary
      if: always()
      run: |
        echo "## ðŸ”’ Security Scan Summary - $(date +'%Y-%m-%d')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "âœ… Manual security scan completed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… Nightly security scan completed" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "View detailed results in the [Security tab](https://github.com/${{ github.repository }}/security/code-scanning)" >> $GITHUB_STEP_SUMMARY