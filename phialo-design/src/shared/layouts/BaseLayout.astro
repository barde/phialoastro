---
import { SEO } from "astro-seo";
import { ClientRouter } from "astro:transitions";
import SmoothScroll from '../components/effects/SmoothScroll';
import CriticalCSS from './CriticalCSS.astro';
import '../../styles/global.css';

export interface Props {
  title: string;
  description?: string;
  image?: string;
  noindex?: boolean;
  lang?: string;
}

// First destructure props to get lang
const {
  title,
  image = "/social/og-default.jpg",
  noindex = false,
  lang = "de"
} = Astro.props;

// Get Cloudflare Analytics token from environment variable
const analyticsToken = import.meta.env.PUBLIC_CLOUDFLARE_ANALYTICS_TOKEN;

// Default descriptions based on language - now lang is available
const defaultDescriptions = {
  de: "Phialo Design - Wo Schmuck auf Innovation trifft. 3D Design, individuelle Kreationen und Expertise in der Schmuckherstellung.",
  en: "Phialo Design - Where jewelry meets innovation. 3D design, individual creations and expertise in jewelry manufacturing."
};

// Set description with fallback
const description = Astro.props.description || defaultDescriptions[lang as keyof typeof defaultDescriptions] || defaultDescriptions.de;

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const socialImageURL = new URL(image, Astro.url).href;

// Generate alternate language URLs for hreflang
const currentPath = Astro.url.pathname;
const isEnglish = currentPath.startsWith('/en/');
const basePath = isEnglish ? currentPath.replace(/^\/en/, '') || '/' : currentPath;
const germanUrl = new URL(basePath, Astro.site).href;
const englishUrl = new URL('/en' + basePath, Astro.site).href;
---

<!DOCTYPE html>
<html lang={lang} class="scroll-smooth">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content={Astro.generator} />
    
    <!-- Font Preloading for better performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    
    <!-- Preload critical images for portfolio page -->
    {(Astro.url.pathname === '/portfolio/' || Astro.url.pathname === '/en/portfolio/') && (
      <>
        <!-- Preload first visible portfolio images in WebP format -->
        <link rel="preload" as="image" href="/images/portfolio/winged-ring-1-800w.webp" type="image/webp" fetchpriority="high" />
        <link rel="preload" as="image" href="/images/portfolio/dna_spirale_freigestellt_refl-800w.webp" type="image/webp" fetchpriority="high" />
        <link rel="preload" as="image" href="/images/portfolio/turmalinring_refl-800w.webp" type="image/webp" fetchpriority="high" />
      </>
    )}
    
    <!-- Google Fonts with font-display:swap for better text rendering -->
    <!-- Using media="print" trick to load fonts asynchronously -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" media="print" onload="this.media='all'" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600&display=swap" media="print" onload="this.media='all'" />
    <noscript>
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" />
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600&display=swap" />
    </noscript>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="sitemap" href="/sitemap-index.xml" />
    
    <!-- Inline critical CSS for faster initial render -->
    <CriticalCSS />
    
    <SEO
      title={title}
      description={description}
      canonical={canonicalURL}
      noindex={noindex}
      openGraph={{
        basic: {
          title: title,
          type: "website",
          image: socialImageURL,
        },
        optional: {
          description: description,
          siteName: "Phialo Design",
        },
      }}
      twitter={{
        creator: "@phialodesign",
        site: "@phialodesign",
        card: "summary_large_image",
      }}
      extend={{
        link: [
          { rel: "icon", href: "/favicon.ico" },
          { rel: "apple-touch-icon", sizes: "180x180", href: "/apple-touch-icon.png" },
          { rel: "alternate", hreflang: "de", href: germanUrl },
          { rel: "alternate", hreflang: "en", href: englishUrl },
          { rel: "alternate", hreflang: "x-default", href: germanUrl }
        ],
        meta: [
          { name: "twitter:image", content: socialImageURL },
          { name: "twitter:title", content: title },
          { name: "twitter:description", content: description },
          { name: "theme-color", content: "#0A192F" },
        ],
      }}
    />
    
    <ClientRouter />
  </head>
  <body class="min-h-screen antialiased">
    <SmoothScroll client:idle />
    <slot />
    
    <!-- Cloudflare Web Analytics - Only load when token is present -->
    {analyticsToken && (
      <script 
        defer 
        src='https://static.cloudflareinsights.com/beacon.min.js' 
        data-cf-beacon={JSON.stringify({ token: analyticsToken })}>
      </script>
    )}
    
    <!-- Performance hints -->
    <script>
      // Preload important resources on interaction
      const preloadOnHover = () => {
        const links = document.querySelectorAll('a[href^="/"]');
        links.forEach(link => {
          link.addEventListener('mouseenter', () => {
            const href = link.getAttribute('href');
            if (href && !document.querySelector(`link[rel="prefetch"][href="${href}"]`)) {
              const prefetchLink = document.createElement('link');
              prefetchLink.rel = 'prefetch';
              prefetchLink.href = href;
              document.head.appendChild(prefetchLink);
            }
          }, { once: true });
        });
      };
      
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', preloadOnHover);
      } else {
        preloadOnHover();
      }
    </script>
  </body>
</html>
