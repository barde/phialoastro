# Optimized Playwright CI Image for GitHub Actions and other CI systems
# This version is optimized for size and speed in CI environments

# Build arguments
ARG BASE_IMAGE=phialo-ci-base:latest
ARG BUILD_DATE
ARG VCS_REF
ARG VERSION=1.0.0

FROM ${BASE_IMAGE} AS browser-deps

# Switch to root for system installations
USER root

# Install only essential browser dependencies (no actual browsers)
# Browsers will be installed via Playwright which gives us better control
RUN apk add --no-cache \
    # Core dependencies for all browsers
    libx11 libxcomposite libxdamage libxext libxfixes \
    libxrandr libxrender libxtst libxi \
    # Audio/Video
    alsa-lib \
    # Fonts - minimal set
    ttf-freefont font-noto \
    # Graphics
    mesa-gl mesa-dri-gallium \
    # Process management
    dumb-init \
    # Xvfb for headless
    xvfb \
    # NSS for Chromium
    nss \
    # GTK for WebKit
    gtk+3.0 \
    # FFmpeg for video recording (smaller than full package)
    ffmpeg-libs

# Clean up apk cache
RUN rm -rf /var/cache/apk/*

# Stage 2: Playwright installation
FROM browser-deps AS playwright-install

# Create Playwright directories with correct permissions
RUN mkdir -p /ms-playwright && \
    chown -R node:node /ms-playwright

# Switch to node user
USER node

# Set Playwright environment
ENV PLAYWRIGHT_BROWSERS_PATH=/ms-playwright \
    PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=0 \
    DISPLAY=:99

WORKDIR /app

# Copy package files
COPY --chown=node:node package.json pnpm-lock.yaml ./

# Install dependencies and Playwright in one layer
RUN pnpm install --frozen-lockfile --prefer-offline && \
    # Install only the browsers we actually use in CI
    pnpm exec playwright install chromium firefox webkit && \
    # Install system dependencies that Playwright needs
    pnpm exec playwright install-deps && \
    # Verify installation
    pnpm exec playwright --version && \
    # Clean pnpm cache
    pnpm store prune && \
    # Remove unnecessary files
    rm -rf ~/.cache/ms-playwright/webkit-*/minidump-reporter \
           ~/.cache/ms-playwright/firefox-*/minidump-reporter

# Stage 3: Final CI image
FROM playwright-install AS final

# Copy test configurations
COPY --chown=node:node playwright*.config.ts ./
COPY --chown=node:node tests ./tests

# Create output directories
RUN mkdir -p test-results playwright-report .playwright && \
    chmod -R 755 test-results playwright-report .playwright

# Add CI-specific scripts
COPY --chown=node:node <<'EOF' /app/scripts/ci-test-runner.sh
#!/bin/sh
# CI test runner with automatic Xvfb management

# Start Xvfb if not already running
if ! pgrep -x Xvfb > /dev/null; then
    echo "Starting Xvfb..."
    Xvfb :99 -screen 0 1280x720x24 -ac +extension GLX +render -noreset &
    sleep 2
fi

# Run tests with proper error handling
exec "$@"
EOF

RUN chmod +x /app/scripts/ci-test-runner.sh

# Healthcheck
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD pnpm exec playwright --version || exit 1

# Use dumb-init to handle signals properly
ENTRYPOINT ["/usr/bin/dumb-init", "--", "/app/scripts/ci-test-runner.sh"]

# Default command for CI
CMD ["pnpm", "run", "test:e2e:ci"]

# Labels
LABEL maintainer="Phialo Design CI" \
      org.opencontainers.image.created="${BUILD_DATE}" \
      org.opencontainers.image.authors="Phialo Design Team" \
      org.opencontainers.image.url="https://github.com/phialo/phialoastro" \
      org.opencontainers.image.documentation="https://github.com/phialo/phialoastro/tree/main/ci/test" \
      org.opencontainers.image.source="https://github.com/phialo/phialoastro" \
      org.opencontainers.image.version="${VERSION}" \
      org.opencontainers.image.revision="${VCS_REF}" \
      org.opencontainers.image.vendor="Phialo Design" \
      org.opencontainers.image.licenses="MIT" \
      org.opencontainers.image.title="Phialo Test Image" \
      org.opencontainers.image.description="Playwright test image for E2E testing"